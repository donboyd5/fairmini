---
output: html_document
editor_options:
  chunk_output_type: console
---

# Equation 1 â€“ Consumer expenditures on services

Estimated as log of real per-capita consumer expenditures on services

{{< include _setup.qmd >}}

{{< include _load_data.qmd >}}

## Variables in the model

Basic specification:

C, C2, AG1, AG2, AG3, ln_cs_pop_l1, ln_yd_pop, RS, ln_aa_pop_l1

Instruments:

Lags test adds ln_cs_pop_l2, ln_yd_pop_l1, RS_l1

![](images/clipboard-1148401271.png)

```{r}
#| label: variables

formula <- ln_cs_pop ~ C2 + AG1 + AG2 + AG3 + ln_cs_pop_l1 + ln_yd_pop + RS + ln_aa_pop_l1

instruments <- ~ C2 + AG1 + AG2 + AG3 + ln_cs_pop_l1 + RS + ln_aa_pop_l1 + ln_cs_pop_l2 + ln_yd_pop_l1 + RS_l1 # not ln_yd_pop

# lags needed:
# 1st lag: ln_cs_pop, ln_yd_pop, RS, ln_aa_pop, C2, AG1, AG2, AG3, ln_ex_pop
# 2nd lag: ln_cs_pop, ln_aa_pop

```

```{r}
#| label: eq
#| output: false

vars <- c("AA", "C", "C2", "CS", "EX", "POP", "RS", "YD")

data1 <- fmdata |> 
  filter(vname %in% vars) |> 
  bind_rows(fmages)
count(data1, vname) # AA, CS, POP, RS, YD

data2 <- data1 |> 
  select(-c(start, end)) |> 
  unnest(cols = data) |> 
  pivot_wider(names_from = vname) |> 
  arrange(date) |> 
  mutate(aa_pop = AA / POP,
         cs_pop = CS / POP,
         yd_pop = YD / POP,
         ln_cs_pop = log(cs_pop),
         ln_aa_pop_l1 = lag(log(aa_pop)),
         ln_cs_pop_l1 = lag(ln_cs_pop),
         ln_yd_pop = log(yd_pop),
         ln_yd_pop_l1 = lag(ln_yd_pop),
         idx = row_number(),
         C = 1,
         C2 = case_when(
           date < T1 ~ 0,
           date < T2 ~ idx - idx[date == T1],
           date >= T2 ~ idx[date == T2] - idx[date == T1],
           .default = NA_real_)) |> 
  # get additional lagged values possibly needed for instrumental variables
  mutate(ln_cs_pop_l2  = lag(ln_cs_pop, 2),
         RS_l1         = lag(RS)) |> 
  na.omit() |>  # drop any row that has an NA in any variable
  filter(date >= smpl$start,
         date <= smpl$end)
summary(data2)

```

## Fair's results for the equation

![](images/clipboard-3503997208.png)

## Estimation and results

```{r}
#| label: eq-estimation
#| output: true



# formula <- ln_cs_pop ~ C2 + AG1 + AG2 + AG3 + ln_cs_pop_l1 + ln_yd_pop + RS + ln_aa_pop_l1
# instruments <- ~ C2 + AG1 + AG2 + AG3 + ln_cs_pop_l2 + ln_yd_pop + RS_l1 + ln_aa_pop_l1

# iv_formula_combine(formula, instruments)

# Apply AR(1) correction with damping
results <- ar1_correction(
  data = data2,
  formula = formula,
  instruments = instruments,
  max_iter = 1000,
  tol = 1e-5,
  damp_factor = 0.5  # Adjust damping factor as needed
)

# View results
summary(results$fit)  # Final 2SLS model

```

{{< include _diagnostics.qmd >}}

```{r stop_here, echo=FALSE}
knitr::knit_exit()
```
